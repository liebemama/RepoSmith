name: Release from tag

on:
  push:
    tags:
      - 'v*'          # Runs automatically when pushing any tag like v0.2.7
  workflow_dispatch:   # Allows manual run

permissions:
  contents: write      # Required to create a Release

jobs:
  make-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: v
        run: |
          tag="${GITHUB_REF##*/}"
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "version=${tag#v}" >> $GITHUB_OUTPUT

      - name: Ensure changelog section exists
        run: |
          ver="${{ steps.v.outputs.version }}"
          if ! grep -q "^## \\[$ver\\]" CHANGELOG.md; then
            echo "❌ CHANGELOG.md does not contain section for [$ver]"
            exit 1
          fi

      - name: Extract release notes from CHANGELOG.md
        id: notes
        shell: bash
        run: |
          ver="${{ steps.v.outputs.version }}"
          # Extract lines from the version header until the next version header
          awk -v ver="$ver" '
            $0 ~ "^## \\["ver"\\]" {flag=1; next}
            $0 ~ "^## \\[" && flag {flag=0}
            flag {print}
          ' CHANGELOG.md > RELEASE_NOTES.md

          # Calculate release notes file size (for diagnostics only)
          bytes=$(wc -c < RELEASE_NOTES.md | tr -d ' ')
          echo "bytes=$bytes" >> $GITHUB_OUTPUT
          echo "----- RELEASE NOTES -----"
          cat RELEASE_NOTES.md || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.v.outputs.tag }}
          name: RepoSmith v${{ steps.v.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false

