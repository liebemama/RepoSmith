name: Release from tag

on:
  push:
    tags:
      - 'v*'          # Runs automatically when pushing any tag like v0.2.7
  workflow_dispatch:   # Allows manual run

permissions:
  contents: write      # Required to create a Release

jobs:
  make-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: v
        run: |
          tag="${GITHUB_REF##*/}"
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "version=${tag#v}" >> $GITHUB_OUTPUT

      - name: Ensure changelog section exists
        run: |
          ver="${{ steps.v.outputs.version }}"
          if ! grep -q "^## \\[$ver\\]" CHANGELOG.md; then
            echo "❌ CHANGELOG.md does not contain section for [$ver]"
            exit 1
          fi

      - name: Extract release notes from CHANGELOG.md
        id: notes
        shell: bash
        run: |
          ver="${{ steps.v.outputs.version }}"

          # Extract lines from the [ver] header until the next version header.
          # Also strip CRLF endings if the file was edited on Windows.
          awk -v ver="$ver" '
            { sub(/\r$/, "", $0) }                       # normalize CRLF -> LF
            $0 ~ "^## \\[" ver "\\]" {flag=1; next}      # start section
            flag && $0 ~ "^## \\[" {flag=0}              # stop at next section
            flag {print}
          ' CHANGELOG.md > RELEASE_NOTES.md

          # Fail early if release notes are empty
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "❌ RELEASE_NOTES.md is empty for version [$ver]."
            echo "   Make sure CHANGELOG.md has a section: ## [$ver]"
            exit 1
          fi

          # Calculate release notes size (diagnostics)
          bytes=$(wc -c < RELEASE_NOTES.md | tr -d ' ')
          echo "bytes=$bytes" >> $GITHUB_OUTPUT
          echo "----- RELEASE NOTES -----"
          cat RELEASE_NOTES.md || true

      - name: Create GitHub Release
        # Tip: for maximum supply-chain security you can pin to a commit SHA.
        # uses: softprops/action-gh-release@<commit-sha>
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.v.outputs.tag }}
          name: RepoSmith v${{ steps.v.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false